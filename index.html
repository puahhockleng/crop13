<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    -->
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script> 
    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <p id="hints" class="mb-1">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC no. Eg T1111111Z" aria-label="NRIC no. Eg T1111111Z" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>

    <div class="row">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>

    <div class="fixed-bottom">
        <button class="btn btn-primary btn-lg" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary btn-lg" id="btnFlip" disabled>Flip selfie</button>
        <button class="btn btn-primary btn-lg" id="btnClearrect" disabled>Clear rectangle</button>
        <button class="btn btn-primary btn-lg" id="btnCrop" disabled>Crop photo</button>
        <button class="btn btn-primary btn-lg" id="btnSave" disabled>Save photo</button>
    </div>
</div>
<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
<script>$(document).ready(function(){var e=$("#hints"),t=$("#fileTocrop"),a=$("#fileTosave"),o=$("#labelTosave"),n=$("#btnRotate"),i=$("#btnFlip"),h=$("#btnClearrect"),r=$("#btnCrop"),d=$("#btnSave"),c=$("#myCanvas"),l=c[0],s=l.getContext("2d"),g=$("#myCanvasTop"),u=g[0],p=u.getContext("2d");p.globalAlpha=.2;var f,v=$("#myCropcanvas"),w=v[0],m=w.getContext("2d"),b=$("#myTempcanvas")[0],M=b.getContext("2d"),C=$("#col2"),R=$("#col3"),k=$("#col4"),y=!1,I=!1,x=5,A=["Rotate/Flip photo if necessary.  Tap, hold and drag on image to draw a rectangle crop area  . . .","Tap, hold and drag on the photo to draw a rectangle area to crop it to size . . . . . . . . . . .","Click on ‘Clear rectangle’ to start again.  Click ‘Crop photo’ if you are satisfied with it . . .","Type in the filename to save as and click ‘Save photo’.","Select a photo from your device to crop."];e.text(A[4]);var T,D;T=l.getBoundingClientRect(),D=window.devicePixelRatio,l.width=Math.round(D*T.right)-Math.round(D*T.left),l.height=Math.round(D*T.bottom)-Math.round(D*T.top),s.scale(D,D),a.hide(),o.hide(),c.hide(),n.hide(),i.hide(),h.hide(),r.hide(),d.hide();var S,L,U=new Image;t.on("change",function(a){e.text(A[0]);var o=new FileReader;o.onload=function(e){U.onload=function(){S=U.width,L=U.height,S>L?S>480&&(L*=480/S,S=480):L>360&&(S*=360/L,L=360),u.width=l.width=S,u.height=l.height=L,s.drawImage(U,0,0,S,L),x=Math.round(5/480*S)},U.src=e.target.result},o.readAsDataURL(a.target.files[0]),c.fadeIn(),C.addClass("col-12"),n.removeAttr("disabled").fadeIn(),i.removeAttr("disabled").fadeIn(),t.hide(),y=!0,I=!0});var j=1,P=!1;n.on("click",function(t){e.text(A[0]),P=!0,z(),j++,P=!1,y=!0});var E=1,F=!1;i.on("click",function(t){e.text(A[0]),F=!0,z(),E++,F=!1,y=!0});var z=function(){s.clearRect(0,0,l.width,l.height);var e=P?j:j-1;e%2==0?(u.width=l.width=S,u.height=l.height=L):(u.width=l.width=L,u.height=l.height=S),s.save(),e%2==0?s.translate(S/2,L/2):s.translate(L/2,S/2),s.rotate(90*e*Math.PI/180),s.translate(-S/2,-L/2),(F?E:E-1)%2==0||(e%2==0?(s.translate(S,0),s.scale(-1,1)):(s.translate(0,L),s.scale(1,-1))),s.drawImage(U,0,0,S,L),s.restore()};$(window).on("scroll",function(e){h.trigger("click")}),$(window).on("resize",function(e){h.trigger("click")}),h.on("click",function(t){e.text(A[1]),V(),p.clearRect(0,0,l.width,l.height),y=!0,r.hide()}),r.on("click",function(){if(e.text(A[3]),h.hide(),r.hide(),d.removeAttr("disabled").fadeIn(),Z>G){var t=Z;Z=G,G=t}if(q>H){t=q;q=H,H=t}f=s.getImageData(Z,q,G-Z,H-q),b.width=G-Z,b.height=H-q,M.putImageData(f,0,0),w.width=240,w.height=320;var n=new Image;n.onload=function(){m.drawImage(n,0,0,240,320)},n.src=b.toDataURL(),C.remove(),R.addClass("col-6"),k.remove(),a.show(),o.show()}),d.on("click",function(){var e=/ipad|iphone|ipod|MSIE|Trident|Edge/i.test(navigator.userAgent.toLowerCase());if(console.log("isiDevice"+e),e){var t="<h2>Right-click on image below and Save-Picture-As</h2> <img src='"+v[0].toDataURL("image/jpeg")+"' alt='from canvas'/>",o=window.open();o.document.write(t),o?o.focus():alert("Please allow popups for this website")}else{var n=document.createElement("a");n.style="position: fixed; left -10000px;",n.href="data:application/octet-stream;base64,"+encodeURIComponent(v[0].toDataURL("image/jpeg").replace(/^data:image\/\w+;base64,/,"")),n.download=""==a.val()?"T1111111Z.jpg":a.val()+".jpg",document.body.appendChild(n),n.click(),document.body.removeChild(n)}}),g.on("mousedown touchstart",function(e){I&&(y||h.trigger("click"),K=!0,N(e),O(B,X,!1))}),g.on("mousemove touchmove",function(e){K&&(N(e),O(B,X,!0),Q())}),g.on("mouseup touchend",function(){K&&(e.text(A[2]),Q(),V(),y=!1)}),g.on("mouseleave touchcancel",function(){K&&(e.text(A[2]),Q(),V(),y=!1)});var B=0,X=0,Y=new Array,J=new Array,W=new Array,Z=0,q=0,G=0,H=0,K=!1,N=function(e){var t=l.getBoundingClientRect(),a=l.width/t.width,o=l.height/t.height;e.touches?(B=(e.touches[0].pageX-t.left)*a,X=(e.touches[0].pageY-t.top)*o,e.preventDefault()):(B=(e.clientX-t.left)*a,X=(e.clientY-t.top)*o)},O=function(e,t,a){Y.push(e),J.push(t),W.push(a)},Q=function(){p.strokeStyle="#df4b26",p.lineJoin="round",p.lineWidth=x,Y.length>0&&(p.clearRect(0,0,l.width,l.height),Z=Y[0],q=J[0],G=Y[Y.length-1],H=J[J.length-1],Z<G&&q<H?(Math.abs(G-Z)/Math.abs(H-q)<.75?H=320/240*(G-Z)+q:G=.75*(H-q)+Z,p.strokeRect(Z,q,Math.abs(G-Z),Math.abs(H-q))):Z>G&&q<H?(Math.abs(G-Z)/Math.abs(H-q)<.75?H=320/240*(Z-G)+q:G=Z-.75*(H-q),p.strokeRect(G,q,Math.abs(G-Z),Math.abs(H-q))):Z<G&&q>H?(Math.abs(G-Z)/Math.abs(H-q)<.75?H=320/240*(G-Z)+q:G=.75*(q-H)+Z,p.strokeRect(Z,H,Math.abs(G-Z),Math.abs(H-q))):(Math.abs(G-Z)/Math.abs(H-q)<.75?H=320/240*(Z-G)+q:G=Z-.75*(q-H),p.strokeRect(G,H,Math.abs(G-Z),Math.abs(H-q))),h.removeAttr("disabled").fadeIn(),r.removeAttr("disabled").fadeIn(),n.hide(),i.hide())},V=function(){Y.length=0,J.length=0,W.length=0,K=!1}});</script>
</body>
</html>