<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    -->
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script> 
    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        @media only screen and (min-width: 768px) { 
            canvas {
                width: 400px;
                height: auto;
            }
        }
        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <p id="hints" class="mb-1">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1" id="fileInput">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC no. Eg T1111111Z" aria-label="NRIC no. Eg T1111111Z" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>

    <div class="row" id="allCanvas">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>

    <div class="fixed-bottom">
        <button class="btn btn-primary btn-lg" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary btn-lg" id="btnFlip" disabled>Flip selfie</button>
        <button class="btn btn-primary btn-lg" id="btnClearrect" disabled>Clear rectangle</button>
        <button class="btn btn-primary btn-lg" id="btnCrop" disabled>Crop photo</button>
        <button class="btn btn-primary btn-lg" id="btnSave" disabled>Save photo</button>
    </div>
</div>
<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
<script>$(document).ready(function(){var t=$("#hints"),e=$("#fileTocrop"),a=$("#fileTosave"),o=$("#labelTosave"),i=$("#btnRotate"),n=$("#btnFlip"),h=$("#btnClearrect"),r=$("#btnCrop"),d=$("#btnSave"),l=$("#myCanvas"),c=l[0],s=c.getContext("2d"),g=$("#myCanvasTop"),u=g[0],p=u.getContext("2d");p.globalAlpha=.2;var f,m=$("#myCropcanvas"),v=m[0],w=v.getContext("2d"),b=$("#myTempcanvas")[0],M=b.getContext("2d"),C=$("#col2"),y=$("#col3"),I=$("#col4"),R=!1,k=!1,x=5,A=!1,T=["Rotate/Flip photo if necessary.  Tap, hold and drag on image to draw a rectangle crop area  . . .","Tap, hold and drag on the photo to draw a rectangle area to crop it to size . . . . . . . . . . .","Click on ‘Clear rectangle’ to start again.  Click ‘Crop photo’ if you are satisfied with it . . .","Type in the filename to save as and click ‘Save photo’.","Select a photo from your device to crop."];t.text(T[4]);var D,L;D=c.getBoundingClientRect(),L=window.devicePixelRatio,c.width=Math.round(L*D.right)-Math.round(L*D.left),c.height=Math.round(L*D.bottom)-Math.round(L*D.top),s.scale(L,L),a.hide(),o.hide(),l.hide(),i.hide(),n.hide(),h.hide(),r.hide(),d.hide();var S,P,U=new Image;e.on("change",function(a){t.text(T[0]);var o=new FileReader;o.onload=function(t){U.onload=function(){S=U.width,P=U.height,S>P?S>480&&(P*=480/S,S=480):P>360&&(S*=360/P,P=360),u.width=c.width=S,u.height=c.height=P,s.drawImage(U,0,0,S,P),x=Math.round(5/480*S)},U.src=t.target.result},o.readAsDataURL(a.target.files[0]),l.fadeIn(),C.addClass("col-12"),i.removeAttr("disabled").fadeIn(),n.removeAttr("disabled").fadeIn(),e.hide(),R=!0,k=!0});var j=1,E=!1;i.on("click",function(e){t.text(T[0]),E=!0,B(),j++,E=!1,R=!0});var F=1,z=!1;n.on("click",function(e){t.text(T[0]),z=!0,B(),F++,z=!1,R=!0});var B=function(){s.clearRect(0,0,c.width,c.height);var t=E?j:j-1;t%2==0?(u.width=c.width=S,u.height=c.height=P):(u.width=c.width=P,u.height=c.height=S),s.save(),t%2==0?s.translate(S/2,P/2):s.translate(P/2,S/2),s.rotate(90*t*Math.PI/180),s.translate(-S/2,-P/2),(z?F:F-1)%2==0||(t%2==0?(s.translate(S,0),s.scale(-1,1)):(s.translate(0,P),s.scale(1,-1))),s.drawImage(U,0,0,S,P),s.restore()};$(window).on("scroll",function(t){A||h.trigger("click")}),$(window).on("resize",function(t){A||h.trigger("click")}),h.on("click",function(e){t.text(T[1]),et(),p.clearRect(0,0,c.width,c.height),R=!0,r.hide()}),r.on("click",function(){if(t.text(T[3]),h.hide(),r.hide(),d.removeAttr("disabled").fadeIn(),H>N){var e=H;H=N,N=e}if(K>O){e=K;K=O,O=e}f=s.getImageData(H,K,N-H,O-K),b.width=N-H,b.height=O-K,M.putImageData(f,0,0),v.width=240,v.height=320;var i=new Image;i.onload=function(){w.drawImage(i,0,0,240,320)},i.src=b.toDataURL(),C.remove(),y.addClass("col-6"),I.remove(),a.show(),o.show(),A=!0});var X=$("#fileInput"),Y=$("#allCanvas");d.on("click",function(){var e=/ipad|iphone|ipod|MSIE|Trident|Edge/i.test(navigator.userAgent.toLowerCase());if(console.log("isiDevice"+e),e){var o="<h2>Tap and hold on the image, tap the Save Image button to save.</h2> <img src='"+m[0].toDataURL("image/jpeg")+"' alt='from canvas'/><h2>Login via <a href='https://myportal.ite.edu.sg/photo/'>myPortal</a> to submit</h2>",i=window.open();i.document.write(o),i?i.focus():alert("Please allow popups for this website")}else{var n=document.createElement("a");n.style="position: fixed; left -10000px;",n.href="data:application/octet-stream;base64,"+encodeURIComponent(m[0].toDataURL("image/jpeg").replace(/^data:image\/\w+;base64,/,"")),n.download=""==a.val()?"T1111111Z.jpg":a.val()+".jpg",document.body.appendChild(n),n.click(),document.body.removeChild(n),t.html("<h2>Login via <a href='https://myportal.ite.edu.sg/photo/'>myPortal</a> to submit</h2>"),d.hide(),X.hide(),Y.hide()}}),g.on("mousedown touchstart",function(t){k&&!A&&(R||h.trigger("click"),Q=!0,V(t),_(J,W,!1))}),g.on("mousemove touchmove",function(t){Q&&!A&&(V(t),_(J,W,!0),tt())}),g.on("mouseup touchend",function(){Q&&!A&&(t.text(T[2]),tt(),et(),R=!1)}),g.on("mouseleave touchcancel",function(){Q&&!A&&(t.text(T[2]),tt(),et(),R=!1)});var J=0,W=0,Z=new Array,q=new Array,G=new Array,H=0,K=0,N=0,O=0,Q=!1,V=function(t){var e=c.getBoundingClientRect(),a=c.width/e.width,o=c.height/e.height;t.touches?(J=(t.touches[0].pageX-e.left)*a,W=(t.touches[0].pageY-e.top)*o,t.preventDefault()):(J=(t.clientX-e.left)*a,W=(t.clientY-e.top)*o)},_=function(t,e,a){Z.push(t),q.push(e),G.push(a)},tt=function(){p.strokeStyle="#df4b26",p.lineJoin="round",p.lineWidth=x,Z.length>0&&(p.clearRect(0,0,c.width,c.height),H=Z[0],K=q[0],N=Z[Z.length-1],O=q[q.length-1],H<N&&K<O?(Math.abs(N-H)/Math.abs(O-K)<.75?O=320/240*(N-H)+K:N=.75*(O-K)+H,p.strokeRect(H,K,Math.abs(N-H),Math.abs(O-K))):H>N&&K<O?(Math.abs(N-H)/Math.abs(O-K)<.75?O=320/240*(H-N)+K:N=H-.75*(O-K),p.strokeRect(N,K,Math.abs(N-H),Math.abs(O-K))):H<N&&K>O?(Math.abs(N-H)/Math.abs(O-K)<.75?O=320/240*(N-H)+K:N=.75*(K-O)+H,p.strokeRect(H,O,Math.abs(N-H),Math.abs(O-K))):(Math.abs(N-H)/Math.abs(O-K)<.75?O=320/240*(H-N)+K:N=H-.75*(K-O),p.strokeRect(N,O,Math.abs(N-H),Math.abs(O-K))),h.removeAttr("disabled").fadeIn(),r.removeAttr("disabled").fadeIn(),i.hide(),n.hide())},et=function(){Z.length=0,q.length=0,G.length=0,Q=!1}});</script>
</body>
</html>