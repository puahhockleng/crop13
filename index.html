<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    -->
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script> 
    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <p id="hints" class="mb-1">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1" id="fileInput">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC no. Eg T1111111Z" aria-label="NRIC no. Eg T1111111Z" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>

    <div class="row" id="allCanvas">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>

    <div class="fixed-bottom">
        <button class="btn btn-primary btn-lg" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary btn-lg" id="btnFlip" disabled>Flip selfie</button>
        <button class="btn btn-primary btn-lg" id="btnClearrect" disabled>Clear rectangle</button>
        <button class="btn btn-primary btn-lg" id="btnCrop" disabled>Crop photo</button>
        <button class="btn btn-primary btn-lg" id="btnSave" disabled>Save photo</button>
    </div>
</div>
<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
<script>$(document).ready(function(){var t=$("#hints"),e=$("#fileTocrop"),a=$("#fileTosave"),o=$("#labelTosave"),i=$("#btnRotate"),n=$("#btnFlip"),h=$("#btnClearrect"),r=$("#btnCrop"),d=$("#btnSave"),c=$("#myCanvas"),l=c[0],s=l.getContext("2d"),g=$("#myCanvasTop"),u=g[0],p=u.getContext("2d");p.globalAlpha=.2;var f,m=$("#myCropcanvas"),v=m[0],w=v.getContext("2d"),b=$("#myTempcanvas")[0],M=b.getContext("2d"),C=$("#col2"),y=$("#col3"),R=$("#col4"),k=!1,I=!1,x=5,A=["Rotate/Flip photo if necessary.  Tap, hold and drag on image to draw a rectangle crop area  . . .","Tap, hold and drag on the photo to draw a rectangle area to crop it to size . . . . . . . . . . .","Click on ‘Clear rectangle’ to start again.  Click ‘Crop photo’ if you are satisfied with it . . .","Type in the filename to save as and click ‘Save photo’.","Select a photo from your device to crop."];t.text(A[4]);var T,D;T=l.getBoundingClientRect(),D=window.devicePixelRatio,l.width=Math.round(D*T.right)-Math.round(D*T.left),l.height=Math.round(D*T.bottom)-Math.round(D*T.top),s.scale(D,D),a.hide(),o.hide(),c.hide(),i.hide(),n.hide(),h.hide(),r.hide(),d.hide();var L,P,S=new Image;e.on("change",function(a){t.text(A[0]);var o=new FileReader;o.onload=function(t){S.onload=function(){L=S.width,P=S.height,L>P?L>480&&(P*=480/L,L=480):P>360&&(L*=360/P,P=360),u.width=l.width=L,u.height=l.height=P,s.drawImage(S,0,0,L,P),x=Math.round(5/480*L)},S.src=t.target.result},o.readAsDataURL(a.target.files[0]),c.fadeIn(),C.addClass("col-12"),i.removeAttr("disabled").fadeIn(),n.removeAttr("disabled").fadeIn(),e.hide(),k=!0,I=!0});var U=1,j=!1;i.on("click",function(e){t.text(A[0]),j=!0,z(),U++,j=!1,k=!0});var E=1,F=!1;n.on("click",function(e){t.text(A[0]),F=!0,z(),E++,F=!1,k=!0});var z=function(){s.clearRect(0,0,l.width,l.height);var t=j?U:U-1;t%2==0?(u.width=l.width=L,u.height=l.height=P):(u.width=l.width=P,u.height=l.height=L),s.save(),t%2==0?s.translate(L/2,P/2):s.translate(P/2,L/2),s.rotate(90*t*Math.PI/180),s.translate(-L/2,-P/2),(F?E:E-1)%2==0||(t%2==0?(s.translate(L,0),s.scale(-1,1)):(s.translate(0,P),s.scale(1,-1))),s.drawImage(S,0,0,L,P),s.restore()};$(window).on("scroll",function(t){h.trigger("click")}),$(window).on("resize",function(t){h.trigger("click")}),h.on("click",function(e){t.text(A[1]),tt(),p.clearRect(0,0,l.width,l.height),k=!0,r.hide()}),r.on("click",function(){if(t.text(A[3]),h.hide(),r.hide(),d.removeAttr("disabled").fadeIn(),G>K){var e=G;G=K,K=e}if(H>N){e=H;H=N,N=e}f=s.getImageData(G,H,K-G,N-H),b.width=K-G,b.height=N-H,M.putImageData(f,0,0),v.width=240,v.height=320;var i=new Image;i.onload=function(){w.drawImage(i,0,0,240,320)},i.src=b.toDataURL(),C.remove(),y.addClass("col-6"),R.remove(),a.show(),o.show()});var B=$("#fileInput"),X=$("#allCanvas");d.on("click",function(){var e=/ipad|iphone|ipod|MSIE|Trident|Edge/i.test(navigator.userAgent.toLowerCase());if(console.log("isiDevice"+e),e){var o="<h2>Right-click on image below and Save-Picture-As</h2> <img src='"+m[0].toDataURL("image/jpeg")+"' alt='from canvas'/><h2>Login via <a href='http://myportal.ite.edu.sg/photo'>myPortal</a> to submit</h2>",i=window.open();i.document.write(o),i?i.focus():alert("Please allow popups for this website")}else{var n=document.createElement("a");n.style="position: fixed; left -10000px;",n.href="data:application/octet-stream;base64,"+encodeURIComponent(m[0].toDataURL("image/jpeg").replace(/^data:image\/\w+;base64,/,"")),n.download=""==a.val()?"T1111111Z.jpg":a.val()+".jpg",document.body.appendChild(n),n.click(),document.body.removeChild(n),t.html("<h2>Login via <a href='http://myportal.ite.edu.sg/photo'>myPortal</a> to submit</h2>"),d.hide(),B.hide(),X.hide()}}),g.on("mousedown touchstart",function(t){I&&(k||h.trigger("click"),O=!0,Q(t),V(Y,J,!1))}),g.on("mousemove touchmove",function(t){O&&(Q(t),V(Y,J,!0),_())}),g.on("mouseup touchend",function(){O&&(t.text(A[2]),_(),tt(),k=!1)}),g.on("mouseleave touchcancel",function(){O&&(t.text(A[2]),_(),tt(),k=!1)});var Y=0,J=0,W=new Array,Z=new Array,q=new Array,G=0,H=0,K=0,N=0,O=!1,Q=function(t){var e=l.getBoundingClientRect(),a=l.width/e.width,o=l.height/e.height;t.touches?(Y=(t.touches[0].pageX-e.left)*a,J=(t.touches[0].pageY-e.top)*o,t.preventDefault()):(Y=(t.clientX-e.left)*a,J=(t.clientY-e.top)*o)},V=function(t,e,a){W.push(t),Z.push(e),q.push(a)},_=function(){p.strokeStyle="#df4b26",p.lineJoin="round",p.lineWidth=x,W.length>0&&(p.clearRect(0,0,l.width,l.height),G=W[0],H=Z[0],K=W[W.length-1],N=Z[Z.length-1],G<K&&H<N?(Math.abs(K-G)/Math.abs(N-H)<.75?N=320/240*(K-G)+H:K=.75*(N-H)+G,p.strokeRect(G,H,Math.abs(K-G),Math.abs(N-H))):G>K&&H<N?(Math.abs(K-G)/Math.abs(N-H)<.75?N=320/240*(G-K)+H:K=G-.75*(N-H),p.strokeRect(K,H,Math.abs(K-G),Math.abs(N-H))):G<K&&H>N?(Math.abs(K-G)/Math.abs(N-H)<.75?N=320/240*(K-G)+H:K=.75*(H-N)+G,p.strokeRect(G,N,Math.abs(K-G),Math.abs(N-H))):(Math.abs(K-G)/Math.abs(N-H)<.75?N=320/240*(G-K)+H:K=G-.75*(H-N),p.strokeRect(K,N,Math.abs(K-G),Math.abs(N-H))),h.removeAttr("disabled").fadeIn(),r.removeAttr("disabled").fadeIn(),i.hide(),n.hide())},tt=function(){W.length=0,Z.length=0,q.length=0,O=!1}});</script>
</body>
</html>