<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    -->
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script> 
    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        @media only screen and (min-width: 500px) { 
            canvas {
                width: 400px;
                height: auto;
            }
        }
        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <p id="hints" class="mb-1">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1" id="fileInput">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC no. Eg T1111111Z" aria-label="NRIC no. Eg T1111111Z" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>

    <div class="alert alert-primary" role="alert" id="alert1">
        This application works best on mobile browsers (Chrome on Android phones & Safari on iPhones/iPads).
    </div>

    <div class="alert alert-danger" role="alert" id="alert2">
        <p>The guidelines of the digital photo for submission:</p>
            <ul>
                <li>must be in colour, taken against <strong>plain white background without shadow</strong></li>
                <li>must be taken within the last 3 months</li>
                <li>show the full face <strong>without headgear</strong> [<strong>eyes, eyebrows & ears</strong> must be visible]</li>
                <li>show that your hair is neatly combed or tied up and must be of <strong>natural colour</strong></li>
                <li>not showing any outrageous earrings</li>
            </ul>
        <img src="https://central.ite.edu.sg/media/Student_Services/CCphoto.jpg" alt="Sample Photo" class="img-thumbnail">
    </div>


    <div class="row" id="allCanvas">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>

    <div class="fixed-bottom">
        <button class="btn btn-primary btn-lg" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary btn-lg" id="btnFlip" disabled>Flip selfie</button>
        <button class="btn btn-primary btn-lg" id="btnClearrect" disabled>Clear rectangle</button>
        <button class="btn btn-primary btn-lg" id="btnCrop" disabled>Crop photo</button>
        <button class="btn btn-primary btn-lg" id="btnSave" disabled>Save photo</button>
    </div>
</div>
<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
<script>$(document).ready(function(){var t=$("#hints"),e=$("#alert1"),a=$("#alert2"),o=$("#fileTocrop"),i=$("#fileTosave"),n=$("#labelTosave"),h=$("#btnRotate"),r=$("#btnFlip"),d=$("#btnClearrect"),l=$("#btnCrop"),c=$("#btnSave"),s=$("#myCanvas"),g=s[0],u=g.getContext("2d"),p=$("#myCanvasTop"),m=p[0],f=m.getContext("2d");f.globalAlpha=.2;var v,w=$("#myCropcanvas"),b=w[0],M=b.getContext("2d"),C=$("#myTempcanvas")[0],y=C.getContext("2d"),I=$("#col2"),R=$("#col3"),k=$("#col4"),x=!1,A=!1,T=5,D=!1,L=["Rotate/Flip photo if necessary.  Tap, hold and drag on image to draw a rectangle crop area  . . .","Tap, hold and drag on the photo to draw a rectangle area to crop it to size . . . . . . . . . . .","Click on ‘Clear rectangle’ to start again.  Click ‘Crop photo’ if you are satisfied with it . . .","Type in the filename to save as and click ‘Save photo’.","Select a photo from your device to crop."];t.text(L[4]);var S,P;S=g.getBoundingClientRect(),P=window.devicePixelRatio,g.width=Math.round(P*S.right)-Math.round(P*S.left),g.height=Math.round(P*S.bottom)-Math.round(P*S.top),u.scale(P,P),i.hide(),n.hide(),s.hide(),h.hide(),r.hide(),d.hide(),l.hide(),c.hide();var U,j,E=new Image;o.on("change",function(i){t.text(L[0]),e.hide(),a.hide();var n=new FileReader;n.onload=function(t){E.onload=function(){U=E.width,j=E.height,U>j?U>480&&(j*=480/U,U=480):j>360&&(U*=360/j,j=360),m.width=g.width=U,m.height=g.height=j,u.drawImage(E,0,0,U,j),T=Math.round(5/480*U)},E.src=t.target.result},n.readAsDataURL(i.target.files[0]),s.fadeIn(),I.addClass("col-12"),h.removeAttr("disabled").fadeIn(),r.removeAttr("disabled").fadeIn(),o.hide(),x=!0,A=!0});var F=1,z=!1;h.on("click",function(e){t.text(L[0]),z=!0,Y(),F++,z=!1,x=!0});var B=1,X=!1;r.on("click",function(e){t.text(L[0]),X=!0,Y(),B++,X=!1,x=!0});var Y=function(){u.clearRect(0,0,g.width,g.height);var t=z?F:F-1;t%2==0?(m.width=g.width=U,m.height=g.height=j):(m.width=g.width=j,m.height=g.height=U),u.save(),t%2==0?u.translate(U/2,j/2):u.translate(j/2,U/2),u.rotate(90*t*Math.PI/180),u.translate(-U/2,-j/2),(X?B:B-1)%2==0||(t%2==0?(u.translate(U,0),u.scale(-1,1)):(u.translate(0,j),u.scale(1,-1))),u.drawImage(E,0,0,U,j),u.restore()},J="";$(window).on("scroll",function(e){J=t.html(),!D&&A&&d.trigger("click"),t.html(J)}),$(window).on("resize",function(e){J=t.html(),!D&&A&&d.trigger("click"),t.html(J)}),d.on("click",function(e){t.text(L[1]),it(),f.clearRect(0,0,g.width,g.height),x=!0,l.hide()}),l.on("click",function(){if(t.text(L[3]),d.hide(),l.hide(),c.removeAttr("disabled").fadeIn(),O>V){var e=O;O=V,V=e}if(Q>_){e=Q;Q=_,_=e}v=u.getImageData(O,Q,V-O,_-Q),C.width=V-O,C.height=_-Q,y.putImageData(v,0,0),b.width=240,b.height=320;var a=new Image;a.onload=function(){M.drawImage(a,0,0,240,320)},a.src=C.toDataURL(),I.remove(),R.addClass("col-6"),k.remove(),i.show(),n.show(),D=!0});var W=$("#fileInput"),Z=$("#allCanvas");c.on("click",function(){var e=/ipad|iphone|ipod|MSIE|Trident|Edge/i.test(navigator.userAgent.toLowerCase());if(console.log("isiDevice"+e),e){var a="<h2>Tap and hold on the image, tap the Save Image button to save.</h2> <img src='"+w[0].toDataURL("image/jpeg")+"' alt='from canvas'/><h2>Login via <a href='https://myportal.ite.edu.sg/photo/'>myPortal</a> to submit</h2>",o=window.open();o.document.write(a),o?o.focus():alert("Please allow popups for this website")}else{var n=document.createElement("a");n.style="position: fixed; left -10000px;",n.href="data:application/octet-stream;base64,"+encodeURIComponent(w[0].toDataURL("image/jpeg").replace(/^data:image\/\w+;base64,/,"")),n.download=""==i.val()?"T1111111Z.jpg":i.val()+".jpg",document.body.appendChild(n),n.click(),document.body.removeChild(n),t.html("<h2>Login via <a href='https://myportal.ite.edu.sg/photo/'>myPortal</a> to submit</h2>"),c.hide(),W.hide(),Z.hide()}}),p.on("mousedown touchstart",function(t){A&&!D&&(x||d.trigger("click"),tt=!0,et(t),at(q,G,!1))}),p.on("mousemove touchmove",function(t){tt&&!D&&(et(t),at(q,G,!0),ot())}),p.on("mouseup touchend",function(){tt&&!D&&(t.text(L[2]),ot(),it(),x=!1)}),p.on("mouseleave touchcancel",function(){tt&&!D&&(t.text(L[2]),ot(),it(),x=!1)});var q=0,G=0,H=new Array,K=new Array,N=new Array,O=0,Q=0,V=0,_=0,tt=!1,et=function(t){var e=g.getBoundingClientRect(),a=g.width/e.width,o=g.height/e.height;t.touches?(q=(t.touches[0].pageX-e.left)*a,G=(t.touches[0].pageY-e.top)*o,t.preventDefault()):(q=(t.clientX-e.left)*a,G=(t.clientY-e.top)*o)},at=function(t,e,a){H.push(t),K.push(e),N.push(a)},ot=function(){f.strokeStyle="#df4b26",f.lineJoin="round",f.lineWidth=T,H.length>0&&(f.clearRect(0,0,g.width,g.height),O=H[0],Q=K[0],V=H[H.length-1],_=K[K.length-1],O<V&&Q<_?(Math.abs(V-O)/Math.abs(_-Q)<.75?_=320/240*(V-O)+Q:V=.75*(_-Q)+O,f.strokeRect(O,Q,Math.abs(V-O),Math.abs(_-Q))):O>V&&Q<_?(Math.abs(V-O)/Math.abs(_-Q)<.75?_=320/240*(O-V)+Q:V=O-.75*(_-Q),f.strokeRect(V,Q,Math.abs(V-O),Math.abs(_-Q))):O<V&&Q>_?(Math.abs(V-O)/Math.abs(_-Q)<.75?_=320/240*(V-O)+Q:V=.75*(Q-_)+O,f.strokeRect(O,_,Math.abs(V-O),Math.abs(_-Q))):(Math.abs(V-O)/Math.abs(_-Q)<.75?_=320/240*(O-V)+Q:V=O-.75*(Q-_),f.strokeRect(V,_,Math.abs(V-O),Math.abs(_-Q))),d.removeAttr("disabled").fadeIn(),l.removeAttr("disabled").fadeIn(),h.hide(),r.hide())},it=function(){H.length=0,K.length=0,N.length=0,tt=!1}});</script>
</body>
</html>