<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    -->
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script> 
    <style>
        canvas {
            width: 100%;
            height: auto;
        }
        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}
    </style>
</head>

<body>

<div class="container-fluid">
    <p id="hints" class="mb-1">Select a photo from your device to crop.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC no. Eg T1111111Z" aria-label="NRIC no. Eg T1111111Z" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>

    <div class="row">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>

    <div class="fixed-bottom">
        <button class="btn btn-primary btn-lg" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary btn-lg" id="btnClearrect" disabled>Clear rectangle</button>
        <button class="btn btn-primary btn-lg" id="btnCrop" disabled>Crop photo</button>
        <button class="btn btn-primary btn-lg" id="btnSave" disabled>Save photo</button>
    </div>
</div>
<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
<script>$(document).ready(function(){var t=$("#hints"),e=$("#fileTocrop"),a=$("#fileTosave"),i=$("#labelTosave"),o=$("#btnRotate"),h=$("#btnClearrect"),n=$("#btnCrop"),d=$("#btnSave"),c=$("#myCanvas"),r=c[0],l=r.getContext("2d"),s=$("#myCanvasTop"),g=s[0],u=g.getContext("2d");u.globalAlpha=.2;var w,f,m,p,v=$("#myCropcanvas"),b=v[0],M=b.getContext("2d"),C=$("#myTempcanvas")[0],R=C.getContext("2d"),y=$("#col2"),I=$("#col3"),k=$("#col4"),x=!1,A=["Rotate photo if necessary.  Tap, hold and drag on image to draw a rectangle crop area.","Tap, hold and drag on the photo to draw a rectangle area to crop it to size.","Click on ‘Clear rectangle’ to start again.  Click ‘Crop photo’ if you are satisfied with it.","Type in the filename to save as and click ‘Save photo’."];m=r.getBoundingClientRect(),p=window.devicePixelRatio,r.width=Math.round(p*m.right)-Math.round(p*m.left),r.height=Math.round(p*m.bottom)-Math.round(p*m.top),l.scale(p,p),a.hide(),i.hide(),c.hide(),o.hide(),h.hide(),n.hide(),d.hide();var D=new Image;e.on("change",function(a){t.text(A[0]);var i=new FileReader;i.onload=function(t){D.onload=function(){var t=D.width,e=D.height;t>e?t>800&&(e*=800/t,t=800):e>600&&(t*=600/e,e=600),g.width=r.width=t,g.height=r.height=e,l.drawImage(D,0,0,t,e),w=l.getImageData(0,0,t,e)},D.src=t.target.result},i.readAsDataURL(a.target.files[0]),c.fadeIn(),y.addClass("col-12"),o.removeAttr("disabled").fadeIn(),e.hide(),x=!0});var T=1;o.on("click",function(e){T%2==0?(g.width=r.width=D.width,g.height=r.height=D.height):(g.width=r.width=D.height,g.height=r.height=D.width),l.clearRect(0,0,r.width,r.height),l.save(),T%2==0?l.translate(D.width/2,D.height/2):l.translate(D.height/2,D.width/2),l.rotate(90*T*Math.PI/180),l.drawImage(D,-D.width/2,-D.height/2),l.restore(),w=l.getImageData(0,0,r.width,r.height),T++,t.text(A[0]),x=!0}),$(window).on("scroll",function(t){h.trigger("click")}),$(window).on("resize",function(t){h.trigger("click")}),h.on("click",function(e){Z(),u.clearRect(0,0,r.width,r.height),x=!0,t.text(A[1]),n.hide()}),n.on("click",function(){if(t.text(A[3]),h.hide(),n.hide(),d.removeAttr("disabled").fadeIn(),B>X){var e=B;B=X,X=e}if(P>Y){e=P;P=Y,Y=e}l.clearRect(0,0,r.width,r.height),l.putImageData(w,0,0),f=l.getImageData(B,P,X-B,Y-P),C.width=X-B,C.height=Y-P,R.rect(0,0,X-B,Y-P),R.fillStyle="white",R.fill(),R.putImageData(f,0,0),b.width=240,b.height=320,M.rect(0,0,240,320),M.fillStyle="white",M.fill();var o=new Image;o.onload=function(){M.drawImage(o,0,0,240,320)},o.src=C.toDataURL(),y.remove(),I.addClass("col-6"),k.remove(),a.show(),i.show()}),d.on("click",function(){var t=document.createElement("a");t.style="position: fixed; left -10000px;",t.href="data:application/octet-stream;base64,"+encodeURIComponent(v[0].toDataURL("image/jpeg").replace(/^data:image\/\w+;base64,/,"")),t.download=""==a.val()?"T1111111Z.jpg":a.val()+".jpg",document.body.appendChild(t),t.click(),document.body.removeChild(t)}),s.on("mousedown touchstart",function(t){x&&(E=!0,F(t),J(S,U,!1))}),s.on("mousemove touchmove",function(t){E&&(F(t),J(S,U,!0),W())}),s.on("mouseup touchend",function(){W(),Z(),x=!1,t.text(A[2])}),s.on("mouseleave touchcancel",function(){Z(),x=!1});var S=0,U=0,j=new Array,L=new Array,z=new Array,B=0,P=0,X=0,Y=0,E=!1,F=function(t){var e=r.getBoundingClientRect(),a=r.width/e.width,i=r.height/e.height;t.touches?(S=(t.touches[0].pageX-e.left)*a,U=(t.touches[0].pageY-e.top)*i,t.preventDefault()):(S=(t.clientX-e.left)*a,U=(t.clientY-e.top)*i)},J=function(t,e,a){j.push(t),L.push(e),z.push(a)},W=function(){u.strokeStyle="#df4b26",u.lineJoin="round",u.lineWidth=20,j.length>0&&(u.clearRect(0,0,r.width,r.height),B=j[0],P=L[0],X=j[j.length-1],Y=L[L.length-1],B<X&&P<Y?(Math.abs(X-B)/Math.abs(Y-P)<.75?Y=320/240*(X-B)+P:X=.75*(Y-P)+B,u.strokeRect(B,P,Math.abs(X-B),Math.abs(Y-P))):B>X&&P<Y?(Math.abs(X-B)/Math.abs(Y-P)<.75?Y=320/240*(B-X)+P:X=B-.75*(Y-P),u.strokeRect(X,P,Math.abs(X-B),Math.abs(Y-P))):B<X&&P>Y?(Math.abs(X-B)/Math.abs(Y-P)<.75?Y=320/240*(X-B)+P:X=.75*(P-Y)+B,u.strokeRect(B,Y,Math.abs(X-B),Math.abs(Y-P))):(Math.abs(X-B)/Math.abs(Y-P)<.75?Y=320/240*(B-X)+P:X=B-.75*(P-Y),u.strokeRect(X,Y,Math.abs(X-B),Math.abs(Y-P))),h.removeAttr("disabled").fadeIn(),n.removeAttr("disabled").fadeIn(),o.hide())},Z=function(){j.length=0,L.length=0,z.length=0,E=!1}});</script>
</body>
</html>