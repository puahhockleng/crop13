<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Photo Uploading and Cropping Tool</title>

    <!-- Latest compiled and minified Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css">
    <!-- jQuery library -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <!-- Popper JS 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js"></script>
    -->
    <!-- Latest compiled JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js"></script> 
    <style>
        canvas {
            width: 80%;
            height: auto;
        }
        @media only screen and (min-width: 500px) { 
            canvas {
                width: 400px;
                height: auto;
            }
        }
        #myCanvasTop { position: absolute; z-index: 2}
        #myCanvas    { position: absolute; z-index: 1}

        .fixed-bottom {
            position: fixed;
            margin: auto;
            height: 100px;
            width: 100%;
            right: 0;
            bottom: 0;
            left: 0;
            z-index: 1030;
        }
    </style>
</head>

<body>

<div class="container-fluid">
    <p id="hints" class="mb-1">ERROR: Your browser does not support this application.  Please try it with another browser.</p>
    <div class="input-group my-0">
        <input id="fileTocrop" type="file" class="form-control"  aria-describedby="basic-addon2">
    </div>

    <div class="input-group mb-1" id="fileInput">
        <input id="fileTosave" type="text" class="form-control" placeholder="NRIC no. Eg T1111111Z" aria-label="NRIC no. Eg T1111111Z" aria-describedby="basic-addon2">
        <div class="input-group-append">
          <span id="labelTosave" class="input-group-text" id="basic-addon2">.jpg</span>
        </div>
    </div>

    <div class="alert alert-primary" role="alert" id="alert1">
        This application works best on mobile browsers (Chrome on Android & Safari on iPhone/iPad).
    </div>

    <div class="row" id="allCanvas">
        <div id="col2">
            <canvas  id="myCanvasTop"></canvas>
            <canvas  id="myCanvas"></canvas>
        </div>
        <div id="col3">
            <canvas  id="myCropcanvas"></canvas>
        </div>
        <div id="col4">
            <canvas  id="myTempcanvas"></canvas>
        </div>
    </div>

    <div class="fixed-bottom">
        <button class="btn btn-primary btn-lg" id="btnRotate" disabled>Rotate photo</button>
        <button class="btn btn-primary btn-lg" id="btnFlip" disabled>Flip selfie</button>
        <button class="btn btn-primary btn-lg" id="btnClearrect" disabled>Clear rectangle</button>
        <button class="btn btn-primary btn-lg" id="btnCrop" disabled>Crop photo</button>
        <button class="btn btn-primary btn-lg" id="btnSave" disabled>Save photo</button>
    </div>
</div>
<!--Copyright (C) 2018 Puah Hock Leng - All Rights Reserved
    Puah_Hock_Leng&#64;ite&#46;edu&#46;sg  -->
<script>$(document).ready(function(){var t=$("#hints"),e=$("#alert1"),a=$("#fileTocrop"),o=$("#fileTosave"),i=$("#labelTosave"),n=$("#btnRotate"),h=$("#btnFlip"),r=$("#btnClearrect"),d=$("#btnCrop"),l=$("#btnSave"),c=$("#myCanvas"),s=c[0],g=s.getContext("2d"),u=$("#myCanvasTop"),p=u[0],f=p.getContext("2d");f.globalAlpha=.2;var m,v=$("#myCropcanvas"),w=v[0],b=w.getContext("2d"),M=$("#myTempcanvas")[0],C=M.getContext("2d"),y=$("#col2"),I=$("#col3"),R=$("#col4"),k=!1,x=!1,A=5,T=!1,D=["Rotate/Flip photo if necessary.  Tap, hold and drag on image to draw a rectangle crop area  . . .","Tap, hold and drag on the photo to draw a rectangle area to crop it to size . . . . . . . . . . .","Click on ‘Clear rectangle’ to start again.  Click ‘Crop photo’ if you are satisfied with it . . .","Type in the filename to save as and click ‘Save photo’.","Select a photo from your device to crop."];t.text(D[4]);var L,S;L=s.getBoundingClientRect(),S=window.devicePixelRatio,s.width=Math.round(S*L.right)-Math.round(S*L.left),s.height=Math.round(S*L.bottom)-Math.round(S*L.top),g.scale(S,S),o.hide(),i.hide(),c.hide(),n.hide(),h.hide(),r.hide(),d.hide(),l.hide();var P,U,j=new Image;a.on("change",function(o){t.text(D[0]),e.hide();var i=new FileReader;i.onload=function(t){j.onload=function(){P=j.width,U=j.height,P>U?P>480&&(U*=480/P,P=480):U>360&&(P*=360/U,U=360),p.width=s.width=P,p.height=s.height=U,g.drawImage(j,0,0,P,U),A=Math.round(5/480*P)},j.src=t.target.result},i.readAsDataURL(o.target.files[0]),c.fadeIn(),y.addClass("col-12"),n.removeAttr("disabled").fadeIn(),h.removeAttr("disabled").fadeIn(),a.hide(),k=!0,x=!0});var E=1,F=!1;n.on("click",function(e){t.text(D[0]),F=!0,X(),E++,F=!1,k=!0});var z=1,B=!1;h.on("click",function(e){t.text(D[0]),B=!0,X(),z++,B=!1,k=!0});var X=function(){g.clearRect(0,0,s.width,s.height);var t=F?E:E-1;t%2==0?(p.width=s.width=P,p.height=s.height=U):(p.width=s.width=U,p.height=s.height=P),g.save(),t%2==0?g.translate(P/2,U/2):g.translate(U/2,P/2),g.rotate(90*t*Math.PI/180),g.translate(-P/2,-U/2),(B?z:z-1)%2==0||(t%2==0?(g.translate(P,0),g.scale(-1,1)):(g.translate(0,U),g.scale(1,-1))),g.drawImage(j,0,0,P,U),g.restore()};$(window).on("scroll",function(t){T||r.trigger("click")}),$(window).on("resize",function(t){T||r.trigger("click")}),r.on("click",function(e){t.text(D[1]),at(),f.clearRect(0,0,s.width,s.height),k=!0,d.hide()}),d.on("click",function(){if(t.text(D[3]),r.hide(),d.hide(),l.removeAttr("disabled").fadeIn(),K>O){var e=K;K=O,O=e}if(N>Q){e=N;N=Q,Q=e}m=g.getImageData(K,N,O-K,Q-N),M.width=O-K,M.height=Q-N,C.putImageData(m,0,0),w.width=240,w.height=320;var a=new Image;a.onload=function(){b.drawImage(a,0,0,240,320)},a.src=M.toDataURL(),y.remove(),I.addClass("col-6"),R.remove(),o.show(),i.show(),T=!0});var Y=$("#fileInput"),J=$("#allCanvas");l.on("click",function(){var e=/ipad|iphone|ipod|MSIE|Trident|Edge/i.test(navigator.userAgent.toLowerCase());if(console.log("isiDevice"+e),e){var a="<h2>Tap and hold on the image, tap the Save Image button to save.</h2> <img src='"+v[0].toDataURL("image/jpeg")+"' alt='from canvas'/><h2>Login via <a href='https://myportal.ite.edu.sg/photo/'>myPortal</a> to submit</h2>",i=window.open();i.document.write(a),i?i.focus():alert("Please allow popups for this website")}else{var n=document.createElement("a");n.style="position: fixed; left -10000px;",n.href="data:application/octet-stream;base64,"+encodeURIComponent(v[0].toDataURL("image/jpeg").replace(/^data:image\/\w+;base64,/,"")),n.download=""==o.val()?"T1111111Z.jpg":o.val()+".jpg",document.body.appendChild(n),n.click(),document.body.removeChild(n),t.html("<h2>Login via <a href='https://myportal.ite.edu.sg/photo/'>myPortal</a> to submit</h2>"),l.hide(),Y.hide(),J.hide()}}),u.on("mousedown touchstart",function(t){x&&!T&&(k||r.trigger("click"),V=!0,_(t),tt(W,Z,!1))}),u.on("mousemove touchmove",function(t){V&&!T&&(_(t),tt(W,Z,!0),et())}),u.on("mouseup touchend",function(){V&&!T&&(t.text(D[2]),et(),at(),k=!1)}),u.on("mouseleave touchcancel",function(){V&&!T&&(t.text(D[2]),et(),at(),k=!1)});var W=0,Z=0,q=new Array,G=new Array,H=new Array,K=0,N=0,O=0,Q=0,V=!1,_=function(t){var e=s.getBoundingClientRect(),a=s.width/e.width,o=s.height/e.height;t.touches?(W=(t.touches[0].pageX-e.left)*a,Z=(t.touches[0].pageY-e.top)*o,t.preventDefault()):(W=(t.clientX-e.left)*a,Z=(t.clientY-e.top)*o)},tt=function(t,e,a){q.push(t),G.push(e),H.push(a)},et=function(){f.strokeStyle="#df4b26",f.lineJoin="round",f.lineWidth=A,q.length>0&&(f.clearRect(0,0,s.width,s.height),K=q[0],N=G[0],O=q[q.length-1],Q=G[G.length-1],K<O&&N<Q?(Math.abs(O-K)/Math.abs(Q-N)<.75?Q=320/240*(O-K)+N:O=.75*(Q-N)+K,f.strokeRect(K,N,Math.abs(O-K),Math.abs(Q-N))):K>O&&N<Q?(Math.abs(O-K)/Math.abs(Q-N)<.75?Q=320/240*(K-O)+N:O=K-.75*(Q-N),f.strokeRect(O,N,Math.abs(O-K),Math.abs(Q-N))):K<O&&N>Q?(Math.abs(O-K)/Math.abs(Q-N)<.75?Q=320/240*(O-K)+N:O=.75*(N-Q)+K,f.strokeRect(K,Q,Math.abs(O-K),Math.abs(Q-N))):(Math.abs(O-K)/Math.abs(Q-N)<.75?Q=320/240*(K-O)+N:O=K-.75*(N-Q),f.strokeRect(O,Q,Math.abs(O-K),Math.abs(Q-N))),r.removeAttr("disabled").fadeIn(),d.removeAttr("disabled").fadeIn(),n.hide(),h.hide())},at=function(){q.length=0,G.length=0,H.length=0,V=!1}});</script>
</body>
</html>